// ===========================================
// CREDITHOPPER - PRISMA SCHEMA
// ===========================================
// PostgreSQL database schema for credit repair platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTHENTICATION
// ===========================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  firstName         String
  lastName          String
  phone             String?
  
  // OAuth providers
  googleId          String?   @unique
  
  // Address (for letters)
  street            String?
  city              String?
  state             String?   @db.VarChar(2)
  zipCode           String?   @db.VarChar(10)
  
  // SSN (only last 4 stored in plain, full is hashed)
  ssnLast4          String?   @db.VarChar(4)
  ssnHash           String?   // bcrypt hash of full SSN for verification
  
  // Subscription
  subscriptionTier  SubscriptionTier @default(FREE)
  subscriptionStart DateTime?
  subscriptionEnd   DateTime?
  stripeCustomerId  String?   @unique
  
  // Trial
  trialStart        DateTime  @default(now())
  trialEnd          DateTime?
  
  // Account status
  isVerified        Boolean   @default(false)
  isActive          Boolean   @default(true)
  personalUseOnly   Boolean   @default(true)
  acceptedTermsAt   DateTime?
  
  // Password reset
  resetToken        String?
  resetTokenExpires DateTime?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  
  // Relations
  creditReports     CreditReport[]
  negativeItems     NegativeItem[]
  disputes          Dispute[]
  wins              Win[]
  activityLogs      ActivityLog[]
  
  @@index([email])
  @@index([stripeCustomerId])
  @@map("users")
}

enum SubscriptionTier {
  FREE        // Template letters only
  STARTER     // Legacy tier
  PRO         // $49/mo - Full engine access, unlimited
  UNLIMITED   // Legacy tier
}

// ===========================================
// CREDIT REPORTS
// ===========================================

model CreditReport {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // File info
  fileName        String
  filePath        String
  fileSize        Int
  mimeType        String
  
  // Source bureau
  bureau          Bureau?
  reportDate      DateTime?
  
  // Parsing status
  parseStatus     ParseStatus   @default(PENDING)
  parsedAt        DateTime?
  parseError      String?
  
  // Parsed data (stored as JSON)
  rawText         String?       @db.Text
  parsedData      Json?         // Structured data after parsing
  
  // Personal info extracted
  reportName      String?
  reportAddress   String?
  
  // Auto-delete after 90 days
  expiresAt       DateTime
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  negativeItems   NegativeItem[]
  
  @@index([userId])
  @@index([parseStatus])
  @@index([expiresAt])
  @@map("credit_reports")
}

enum Bureau {
  EQUIFAX
  EXPERIAN
  TRANSUNION
}

enum ParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ===========================================
// NEGATIVE ITEMS
// ===========================================

model NegativeItem {
  id                    String        @id @default(uuid())
  userId                String
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditReportId        String?
  creditReport          CreditReport? @relation(fields: [creditReportId], references: [id], onDelete: SetNull)
  
  // Account info
  creditorName          String
  originalCreditor      String?       // If different from current
  accountNumber         String?
  accountNumberMasked   String?       // e.g., "XXXX1234"
  accountType           AccountType
  
  // Financial
  balance               Decimal?      @db.Decimal(12, 2)
  originalBalance       Decimal?      @db.Decimal(12, 2)
  highCredit            Decimal?      @db.Decimal(12, 2)
  creditLimit           Decimal?      @db.Decimal(12, 2)
  monthlyPayment        Decimal?      @db.Decimal(12, 2)
  
  // Status
  accountStatus         String?       // e.g., "Collection", "Charged Off"
  paymentStatus         String?       // e.g., "120 Days Late"
  
  // Important dates
  dateOpened            DateTime?
  dateClosed            DateTime?
  dateOfFirstDelinquency DateTime?    // DOFD - critical for 7-year calc
  lastActivityDate      DateTime?     // For SOL calculation
  lastReportedDate      DateTime?
  
  // Bureau presence
  onEquifax             Boolean       @default(false)
  onExperian            Boolean       @default(false)
  onTransunion          Boolean       @default(false)
  
  // Calculated fields (updated by system)
  fallsOffDate          DateTime?     // DOFD + 7 years
  monthsUntilFallsOff   Int?
  solExpired            Boolean?      // Statute of limitations expired?
  
  // Recommendation
  recommendation        DisputeRecommendation?
  recommendationReason  String?
  
  // Item status
  status                ItemStatus    @default(ACTIVE)
  deletedFromBureaus    Bureau[]      // Which bureaus deleted it
  
  // Notes
  notes                 String?       @db.Text
  
  // Timestamps
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  // Relations
  disputes              Dispute[]
  wins                  Win[]
  furnisher             Furnisher?    @relation(fields: [furnisherId], references: [id])
  furnisherId           String?
  
  @@index([userId])
  @@index([creditReportId])
  @@index([accountType])
  @@index([status])
  @@index([fallsOffDate])
  @@map("negative_items")
}

enum AccountType {
  COLLECTION
  LATE_PAYMENT
  CHARGE_OFF
  REPOSSESSION
  FORECLOSURE
  BANKRUPTCY
  JUDGMENT
  TAX_LIEN
  INQUIRY
  MEDICAL
  STUDENT_LOAN
  CREDIT_CARD
  AUTO_LOAN
  MORTGAGE
  PERSONAL_LOAN
  OTHER
}

enum ItemStatus {
  ACTIVE          // Still on report
  DISPUTING       // Currently being disputed
  DELETED         // Successfully removed
  UPDATED         // Modified but not removed
  VERIFIED        // Bureau verified it
  WAITING         // Recommended to wait for fall-off
}

enum DisputeRecommendation {
  DISPUTE_NOW     // More than 12 months until fall-off
  OPTIONAL        // 6-12 months until fall-off
  WAIT            // Less than 6 months - might fall off naturally
  DO_NOT_DISPUTE  // SOL concern or other reason
}

// ===========================================
// FURNISHERS (Creditors/Collectors)
// ===========================================

model Furnisher {
  id              String    @id @default(uuid())
  name            String
  alternateName   String?   // DBA or collection agency name
  
  // Address
  street          String?
  city            String?
  state           String?   @db.VarChar(2)
  zipCode         String?   @db.VarChar(10)
  
  // Contact
  phone           String?
  fax             String?
  website         String?
  
  // Metadata
  furnisherType   FurnisherType @default(CREDITOR)
  isFtcBanned     Boolean   @default(false)  // On FTC banned list
  responsePattern String?   // Known behavior patterns
  avgResponseDays Int?      // Historical response time
  successRate     Decimal?  @db.Decimal(5, 2) // Historical deletion rate
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  negativeItems   NegativeItem[]
  disputes        Dispute[]
  
  @@index([name])
  @@map("furnishers")
}

enum FurnisherType {
  CREDITOR
  COLLECTION_AGENCY
  ORIGINAL_CREDITOR
  DEBT_BUYER
  MEDICAL_PROVIDER
  UTILITY
  GOVERNMENT
  OTHER
}

// ===========================================
// DISPUTES
// ===========================================

model Dispute {
  id                String        @id @default(uuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  negativeItemId    String
  negativeItem      NegativeItem  @relation(fields: [negativeItemId], references: [id], onDelete: Cascade)
  
  // Target
  target            DisputeTarget
  bureau            Bureau?       // If targeting bureau
  furnisherId       String?       // If targeting furnisher
  furnisher         Furnisher?    @relation(fields: [furnisherId], references: [id])
  
  // Round tracking (1-4)
  round             Int           @default(1)
  strategy          DisputeStrategy?
  
  // Letter
  letterContent     String?       @db.Text
  letterTemplate    String?       // Template ID used
  letterGeneratedAt DateTime?
  
  // Mailing
  mailedAt          DateTime?
  mailedMethod      MailMethod?
  trackingNumber    String?
  
  // Response tracking
  responseDueDate   DateTime?     // 30 days from mailed date
  responseReceived  Boolean       @default(false)
  responseDate      DateTime?
  responseType      ResponseType?
  responseNotes     String?       @db.Text
  
  // Status
  status            DisputeStatus @default(DRAFT)
  
  // Timestamps
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  completedAt       DateTime?
  
  // Relations
  documents         DisputeDocument[]
  
  @@index([userId])
  @@index([negativeItemId])
  @@index([status])
  @@index([responseDueDate])
  @@map("disputes")
}

enum DisputeTarget {
  BUREAU
  FURNISHER
}

enum DisputeStrategy {
  INITIAL_DISPUTE       // Round 1: Basic dispute
  METHOD_OF_VERIFICATION // Round 2: Demand MOV
  PROCEDURAL_VIOLATION  // Round 3: Cite FCRA violations
  LEGAL_ESCALATION      // Round 4: Legal demand + complaint threat
  DEBT_VALIDATION       // For collectors
  GOODWILL_REQUEST      // For late payments with good history
  IDENTITY_THEFT        // Fraud dispute
}

enum MailMethod {
  REGULAR
  CERTIFIED
  CERTIFIED_RETURN_RECEIPT
}

enum ResponseType {
  DELETED             // Item removed
  VERIFIED            // Bureau says it's accurate
  UPDATED             // Info changed but not removed
  NO_RESPONSE         // No response within deadline
  FRIVOLOUS           // Bureau claims frivolous
  INVESTIGATING       // Still investigating
  PARTIAL_DELETE      // Some info removed
}

enum DisputeStatus {
  DRAFT               // Letter being prepared
  READY               // Ready to send
  MAILED              // Sent, waiting response
  RESPONSE_RECEIVED   // Got a response
  COMPLETED           // Dispute cycle complete
  ESCALATED           // Moved to next round
  CANCELLED           // User cancelled
}

// ===========================================
// DISPUTE DOCUMENTS
// ===========================================

model DisputeDocument {
  id            String          @id @default(uuid())
  disputeId     String
  dispute       Dispute         @relation(fields: [disputeId], references: [id], onDelete: Cascade)
  
  // Document info
  documentType  DocumentType
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String
  
  // Description
  description   String?
  
  // Timestamps
  createdAt     DateTime        @default(now())
  
  @@index([disputeId])
  @@map("dispute_documents")
}

enum DocumentType {
  LETTER_SENT         // Dispute letter we sent
  RESPONSE_RECEIVED   // Response from bureau/furnisher
  SUPPORTING_DOC      // User-provided evidence
  CERTIFIED_RECEIPT   // Proof of mailing
  COMPLAINT           // CFPB/FTC/AG complaint
}

// ===========================================
// WINS (Successful Deletions)
// ===========================================

model Win {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  negativeItemId  String
  negativeItem    NegativeItem  @relation(fields: [negativeItemId], references: [id], onDelete: Cascade)
  
  // What was achieved
  winType         WinType
  bureausAffected Bureau[]
  
  // Financial impact
  debtEliminated  Decimal?      @db.Decimal(12, 2)
  estimatedScoreImpact Int?     // Estimated points gained
  
  // Details
  description     String?
  roundAchieved   Int?          // Which round got the win
  
  // Timestamps
  achievedAt      DateTime      @default(now())
  
  @@index([userId])
  @@index([achievedAt])
  @@map("wins")
}

enum WinType {
  FULL_DELETION       // Completely removed
  PARTIAL_DELETION    // Some info removed
  BALANCE_UPDATE      // Balance corrected
  STATUS_UPDATE       // Status changed favorably
  DATE_CORRECTION     // Dates corrected
  ACCOUNT_CLOSED      // Closed as requested
}

// ===========================================
// REGULATORY COMPLAINTS
// ===========================================

model RegulatoryComplaint {
  id              String          @id @default(uuid())
  userId          String
  
  // Target
  agency          ComplaintAgency
  targetType      DisputeTarget
  targetBureau    Bureau?
  targetFurnisher String?
  
  // Complaint details
  complaintNumber String?         // Agency reference number
  filedAt         DateTime        @default(now())
  status          ComplaintStatus @default(FILED)
  
  // Content
  complaintText   String          @db.Text
  
  // Response
  responseReceived Boolean        @default(false)
  responseDate    DateTime?
  responseNotes   String?         @db.Text
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([userId])
  @@map("regulatory_complaints")
}

enum ComplaintAgency {
  CFPB              // Consumer Financial Protection Bureau
  FTC               // Federal Trade Commission
  STATE_AG          // State Attorney General
  BBB               // Better Business Bureau
}

enum ComplaintStatus {
  DRAFT
  FILED
  ACKNOWLEDGED
  INVESTIGATING
  RESOLVED
  CLOSED
}

// ===========================================
// ACTIVITY LOG
// ===========================================

model ActivityLog {
  id          String        @id @default(uuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Activity
  action      ActivityAction
  description String
  
  // Related entities
  entityType  String?       // e.g., "dispute", "negative_item"
  entityId    String?
  
  // Metadata
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  
  // Timestamp
  createdAt   DateTime      @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("activity_logs")
}

enum ActivityAction {
  // Auth
  REGISTERED
  LOGGED_IN
  LOGGED_OUT
  PASSWORD_CHANGED
  PASSWORD_RESET
  
  // Reports
  REPORT_UPLOADED
  REPORT_PARSED
  REPORT_DELETED
  
  // Items
  ITEM_ADDED
  ITEM_UPDATED
  ITEM_DELETED
  
  // Disputes
  DISPUTE_CREATED
  DISPUTE_SENT
  DISPUTE_RESPONSE
  DISPUTE_ESCALATED
  
  // Letters
  LETTER_GENERATED
  LETTER_DOWNLOADED
  
  // Wins
  WIN_RECORDED
  
  // Account
  PROFILE_UPDATED
  SUBSCRIPTION_CHANGED
}

// ===========================================
// REFERENCE DATA: STATE LAWS
// ===========================================

model StateLaw {
  id                String    @id @default(uuid())
  stateCode         String    @unique @db.VarChar(2)
  stateName         String
  
  // Statute of Limitations (in years)
  solWrittenContract    Int   // Written contracts
  solOralContract       Int   // Oral/verbal agreements
  solPromissoryNote     Int   // Promissory notes
  solOpenAccount        Int   // Open-ended accounts (credit cards)
  
  // Additional protections
  additionalProtections String? @db.Text  // State-specific consumer protections
  
  // Timestamps
  updatedAt         DateTime  @updatedAt
  
  @@map("state_laws")
}

// ===========================================
// REFERENCE DATA: BUREAU ADDRESSES
// ===========================================

model BureauAddress {
  id              String    @id @default(uuid())
  bureau          Bureau    @unique
  
  // Dispute address
  disputeStreet   String
  disputeCity     String
  disputeState    String    @db.VarChar(2)
  disputeZip      String    @db.VarChar(10)
  
  // Online dispute URL
  onlineDisputeUrl String?
  
  // Phone
  phone           String?
  
  // Timestamps
  updatedAt       DateTime  @updatedAt
  
  @@map("bureau_addresses")
}

// ===========================================
// LETTER TEMPLATES
// ===========================================

model LetterTemplate {
  id              String          @id @default(uuid())
  
  // Template info
  name            String
  description     String?
  category        TemplateCategory
  
  // Targeting
  targetType      DisputeTarget
  accountTypes    AccountType[]   // Which account types this works for
  round           Int?            // Specific round, or null for any
  
  // Content
  content         String          @db.Text
  variables       String[]        // List of variables like {{creditor_name}}
  
  // Phrase variations (for anti-template detection)
  phraseVariations Json?          // {"greeting": ["Dear Sir/Madam", "To Whom It May Concern"]}
  
  // Metadata
  isActive        Boolean         @default(true)
  isPremium       Boolean         @default(false)
  useCount        Int             @default(0)
  successRate     Decimal?        @db.Decimal(5, 2)
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([category])
  @@index([targetType])
  @@map("letter_templates")
}

enum TemplateCategory {
  INITIAL_DISPUTE
  METHOD_OF_VERIFICATION
  PROCEDURAL_VIOLATION
  LEGAL_DEMAND
  DEBT_VALIDATION
  GOODWILL
  IDENTITY_THEFT
  PAY_FOR_DELETE
  CEASE_AND_DESIST
  CFPB_COMPLAINT
}

// ===========================================
// BUNDLE LEADS & DOWNLOADS
// ===========================================

model BundleLead {
  id          String   @id @default(uuid())
  email       String
  firstName   String?
  bundleId    String
  bundleName  String
  ipAddress   String?
  userAgent   String?
  source      String?  @default("website")
  convertedAt DateTime?
  createdAt   DateTime @default(now())
  
  @@unique([email, bundleId])
  @@index([email])
  @@index([bundleId])
  @@index([createdAt])
  @@map("bundle_leads")
}

model BundleDownload {
  id          String   @id @default(uuid())
  email       String?
  bundleId    String
  bundleName  String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([bundleId])
  @@index([email])
  @@index([createdAt])
  @@map("bundle_downloads")
}
